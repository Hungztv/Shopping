@{
    ViewData["Title"] = "Dashboard";
}

<div class="container-fluid p-0">
    <!-- Stats Cards Row -->
    <div class="row g-4 mb-4 fade-in">
        <div class="col-xl-3 col-md-6">
            <div class="stat-card">
                <div class="stat-icon primary">
                    <i class="fas fa-shopping-bag"></i>
                </div>
                <h3>@ViewBag.CountOrder</h3>
                <p>Tổng đơn hàng</p>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stat-card">
                <div class="stat-icon success">
                    <i class="fas fa-box-open"></i>
                </div>
                <h3>@ViewBag.CountProduct</h3>
                <p>Tổng sản phẩm</p>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stat-card">
                <div class="stat-icon warning">
                    <i class="fas fa-folder"></i>
                </div>
                <h3>@ViewBag.CountCategory</h3>
                <p>Danh mục sản phẩm</p>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stat-card">
                <div class="stat-icon danger">
                    <i class="fas fa-users"></i>
                </div>
                <h3>@ViewBag.CountUser</h3>
                <p>Tổng khách hàng</p>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row g-4">
        <div class="col-12">
            <div class="admin-card">
                <div class="card-header-custom">
                    <span><i class="fas fa-chart-line"></i> Thống kê doanh thu & đơn hàng</span>
                </div>
                <div class="card-body p-4">
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label class="form-label-custom">Lọc theo ngày</label>
                            <div class="input-group">
                                <input type="text" class="form-control-custom" id="datepicker" placeholder="Chọn ngày">
                                <button type="button" class="btn-custom-primary btn-filter-date ms-2">
                                    <i class="fas fa-filter"></i> Lọc
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label-custom">Lọc theo khoảng thời gian</label>
                            <select class="form-control-custom filter-date">
                                <option value="last_month">Tháng trước</option>
                                <option value="this_month">Tháng này</option>
                                <option value="all_year">Cả năm</option>
                            </select>
                        </div>
                    </div>
                    <div id="myfirstchart" style="height: 350px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.14.0/jquery-ui.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.min.js"></script>
    <script>
        $(document).ready(function () {
            var chart = new Morris.Line({
                element: 'myfirstchart',
                xkey: 'date',
                ykeys: ['revenue', 'orders'],
                labels: ['Doanh thu', 'Đơn hàng'],
                parseTime: false,
                lineColors: ['#667eea', '#f56565'],
                pointSize: 4,
                hideHover: 'auto'
            });

            // Lấy dữ liệu ban đầu
            $.ajax({
                type: "POST",
                url: "@Url.Action("GetChartData", "Dashboard")",
                dataType: "json",
                success: function (data) {
                    data.forEach(function (item) {
                        item.date = new Date(item.date).toLocaleDateString('vi-VN');
                    });
                    chart.setData(data);
                },
                error: function (xhr, status, error) {
                    console.log("Error loading initial chart data: " + error);
                }
            });

            // Lọc theo select
            $(".filter-date").change(function () {
                var filterdate = $(this).val();
                $.ajax({
                    type: "POST",
                    url: "@Url.Action("SelectFilterDate", "Dashboard")",
                    data: { filterdate: filterdate },
                    dataType: "json",
                    success: function (data) {
                        data.forEach(function (item) {
                            item.date = new Date(item.date).toLocaleDateString('vi-VN');
                        });
                        chart.setData(data);
                    },
                    error: function (xhr, status, error) {
                        console.log("Error filtering by select: " + error);
                    }
                });
            });

            // Lọc theo ngày chọn
            $(".btn-filter-date").click(function () {
                var filterdate = $("#datepicker").val();
                if (filterdate) {
                    $.ajax({
                        type: "POST",
                        url: "@Url.Action("SubmitFilterDate", "Dashboard")",
                        data: { filterdate: filterdate },
                        dataType: "json",
                        success: function (data) {
                            data.forEach(function (item) {
                                item.date = new Date(item.date).toLocaleDateString('vi-VN');
                            });
                            chart.setData(data);
                        },
                        error: function (xhr, status, error) {
                            console.log("Error filtering by date: " + error);
                        }
                    });
                }
            });

            // Khởi tạo datepicker
            $("#datepicker").datepicker({
                dateFormat: 'yy-mm-dd',
                onSelect: function (datetext) {
                    $('#datepicker').val(datetext);
                }
            });
        });
    </script>
}