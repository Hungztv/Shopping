@model IEnumerable<OrderDetail>

@{
    ViewData["title"] = "Order Details";
    // decimal total = 0; 
    // decimal subtotal = 0;

}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Order Details</title>
</head>
<body>
    <h3>Order Details</h3>


    <div class="table table-responsive">
        <table class="table" id="detail_order">
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Order Code</th>
                    <th>UserName</th>
                    <th>Product Name</th>
                    <th>Product Price</th>
                    <th>Quantity</th>
                    <th>Subtotal</th>
                    <th>Shipping Cost</th>
                </tr>
            </thead>
            <tbody>
                @{
                    decimal total = 0;
                }
                @foreach (var item in Model)
                {
                    var subtotal = item.Price * item.Quantity;
                    total += subtotal;
                    <tr>
                        <td>@item.Id</td>
                        <td>@item.OrderCode</td>
                        <td>@item.UserName</td>
                        <td>@(item.Product != null ? item.Product.Name : "N/A")</td>
                        <td>@item.Price.ToString("#,##0 VNĐ")</td>
                        <td>@item.Quantity</td>
                        <td>@subtotal.ToString("#,##0 VNĐ")</td>
                    </tr>
                }
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="6" class="text-right"><strong>Total:</strong></td>
                    <td><strong>@total.ToString("#,##0 VNĐ")</strong></td>
                    <td>Shipping Cost: @ViewBag.ShippingCost.ToString("#,##0 VNĐ")</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <tr>
        

        <td>
            @if (@ViewBag.Status != 3)
            {
                <select class="form-control select-update-order">

                    <option value="1">Đơn hàng mới</option>
                    <option value="0">Đã xử lý</option>


                </select>
            }
        </td>
    </tr>
  



</body>

</html>
@section Scripts {
    <script>
        // Khởi tạo DataTable
        new DataTable('#detail_order', {
            layout: {
                topStart: {
                    buttons: ['pdf', 'print']
                }
            }
        });

           
                $('.select-update-order').change(function () {
            var status = $(this).val();

           var ordercode = $(this).parents('tr').find('td:nth-child(2)').text().trim();

            console.log("Order Code lấy được:", ordercode); 

            if (!ordercode) {
                Swal.fire("Lỗi!", "Không lấy được mã đơn hàng.", "error");
                return;
            }

            $.ajax({
                type: "POST",
                url: "/Admin/Order/UpdateOrder",
                data: { status: status, ordercode: ordercode },
                success: function (result) {
                    if (result.success) {
                        Swal.fire("Thành công!", result.message, "success");
                    } else {
                        Swal.fire("Thất bại!", result.message, "error");
                    }
                },
                error: function (xhr) {
                    Swal.fire("Lỗi!", "Lỗi máy chủ: " + xhr.responseText, "error");
                }
            });
        });

    </script>
}
    <script>
        $(document).ready(function () {
            $('.select-update-order').change(function () {
                var status = $(this).val(); //status = 1
                var ordercode = $('.getId').val(); //
                // alert(status);
                // alert(ordercode);

                $.ajax({
                    type: "POST",
                    url: "@Url.Action("UpdateOrder")",
                    data: { status: status, ordercode: ordercode }, // Send data to the server

                    success: function (result) {
                        // Handle successful update
                        if (result.success) {

                            Swal.fire("Cập nhật đơn hàng thành công.");
                        } else {

                            Swal.fire("Cập nhật đơn hàng thất bại." + result.message);

                        }
                    }

                });
            });
        });
    </script>




